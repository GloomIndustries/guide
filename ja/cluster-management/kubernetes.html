<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="All you need to know about Screwdriver and more">
    
    
    <link rel="shortcut icon" href="/themes/sd/img/favicon.ico">

    <title>Kubernetes - Screwdriver Guide</title>

    <link href="/themes/sd/css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="/themes/sd/css/font-awesome-4.5.0.css" rel="stylesheet">
    <link href="/themes/sd/css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="/themes/sd/css/highlight.css">
    
    <link href="/css/homepage.css" rel="stylesheet">
    
    <link href="/css/navbar.css" rel="stylesheet">
    
    <link href="/css/yaml.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-88158708-1', 'docs.screwdriver.cd');
        ga('send', 'pageview');
    </script>
    
</head>

<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="/ja/">Screwdriver Guide</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#jekyll_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/screwdriver-cd/guide">
                        
                        <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
        <div class="navbar-collapse collapse">
            
            <div class="navbar-title col-md-12">
                Kubernetes
            </div>
            
        </div>
        <div class="navbar-collapse collapse">
            
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
                
                
                <li >
                    <a href="/ja">ホーム</a>
                </li>
                
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">クラスター管理 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
<li >
    <a href="/ja/cluster-management/">全体の構成</a>
</li>


                        
                        
<li >
    <a href="/ja/cluster-management/configure-api">APIの設定</a>
</li>


                        
                        
<li >
    <a href="/ja/cluster-management/configure-ui">UIの設定</a>
</li>


                        
                        
<li >
    <a href="/ja/cluster-management/configure-store">Storeの設定</a>
</li>


                        
                        
<li >
    <a href="/ja/cluster-management/running-locally">ローカルで実行</a>
</li>


                        
                        
<li class="dropdown-submenu">
    <a tabindex="-1" href="">設定例</a>
    <ul class="dropdown-menu">
        
        
<li >
    <a href="/ja/cluster-management/kubernetes">Kubernetes</a>
</li>


        
    </ul>
</li>


                        
                    </ul>
                </li>
                
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">ユーザーガイド <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
<li >
    <a href="/ja/user-guide/quickstart">クイックスタート</a>
</li>


                        
                        
<li >
    <a href="/ja/user-guide/api">API</a>
</li>


                        
                        
<li >
    <a href="/ja/user-guide/authentication-authorization">認証と認可</a>
</li>


                        
                        
<li class="dropdown-submenu">
    <a tabindex="-1" href="">設定</a>
    <ul class="dropdown-menu">
        
        
<li >
    <a href="/ja/user-guide/configuration/">全体</a>
</li>


        
        
<li >
    <a href="/ja/user-guide/configuration/metadata">Metadata</a>
</li>


        
        
<li >
    <a href="/ja/user-guide/configuration/secrets">Secrets</a>
</li>


        
    </ul>
</li>


                        
                        
<li >
    <a href="/ja/user-guide/environment-variables">Environment Variables</a>
</li>


                        
                        
<li >
    <a href="/ja/user-guide/templates">Templates</a>
</li>


                        
                        
<li >
    <a href="/ja/user-guide/FAQ">FAQ</a>
</li>


                        
                    </ul>
                </li>
                
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">概要 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
<li >
    <a href="/ja/about">Screwdriverとは</a>
</li>


                        
                        
<li class="dropdown-submenu">
    <a tabindex="-1" href="">付録</a>
    <ul class="dropdown-menu">
        
        
<li >
    <a href="/ja/about/appendix/domain">ドメインモデル</a>
</li>


        
        
<li >
    <a href="/ja/about/appendix/execution-engines">Execution Engines</a>
</li>


        
    </ul>
</li>


                        
                        
<li >
    <a href="/ja/about/contributing">貢献する</a>
</li>


                        
                        
<li >
    <a href="/ja/about/support">サポート</a>
</li>


                        
                    </ul>
                </li>
                
                
            </ul>
            
        </div>
    </div>
</div>

<div class="container">
    
    
    <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        
        
        <li class="main active"><a href="#kubernetesを利用してaws上にscrewdriverのクラスタを構築">Kubernetesを利用してAWS上にScrewdriverのクラスタを構築</a></li>
        
        
        
        <li><a href="#screwdriverクラスタ">Screwdriverクラスタ</a></li>
        
        
        
        <li><a href="#必要なもの">必要なもの</a></li>
        
        
        
        <li><a href="#kubernetesクラスタの作成">Kubernetesクラスタの作成</a></li>
        
        
        
        <li><a href="#setup-screwdriver-secrets">Setup Screwdriver secrets</a></li>
        
        
        
        <li><a href="#screwdriverのデプロイ">Screwdriverのデプロイ</a></li>
        
        
        
        <li><a href="#podsの確認">Podsの確認</a></li>
        
        
        
        <li><a href="#oauth-applicationの更新">OAuth Applicationの更新</a></li>
        
        
    </ul>
</div>
</div>
    
    <div class="col-md-9" role="main">
    <h1 id="kubernetesを利用してaws上にscrewdriverのクラスタを構築">Kubernetesを利用してAWS上にScrewdriverのクラスタを構築</h1>

<p>We’ll go over how to set up a Screwdriver cluster on AWS using Kubernetes, Github, and a Postgres database. You can setup a Screwdriver cluster using <a href="http://kubernetes.io/docs/whatisk8s/">Kubernetes</a>.</p>

<h2 id="screwdriverクラスタ">Screwdriverクラスタ</h2>

<p>A Screwdriver cluster consists of a Kubernetes cluster running the Screwdriver API. The Screwdriver API modifies Screwdriver tables in AWS RDS.</p>

<p><img src="../../cluster-management/assets/cluster-setup-architecture.png" alt="Cluster setup architecture" /></p>

<h2 id="必要なもの">必要なもの</h2>

<ul>
  <li><a href="http://kubernetes.io/docs/user-guide/prereqs/">kubectl</a></li>
  <li><a href="http://aws.amazon.com">AWS</a>アカウント</li>
  <li><a href="https://aws.amazon.com/cli/">AWS CLI</a></li>
</ul>

<h2 id="kubernetesクラスタの作成">Kubernetesクラスタの作成</h2>

<p>Follow instructions at <a href="http://kubernetes.io/docs/getting-started-guides/aws/">Running Kubernetes on AWS EC2</a>.</p>

<h2 id="setup-screwdriver-secrets">Setup Screwdriver secrets</h2>

<p>After creating your Kubernetes cluster, you’ll need to populate it with some secrets that will give you access to your database and Github.
A <a href="http://kubernetes.io/docs/user-guide/secrets/">Secret</a> is an object that contains a small amount of sensitive data such as a password, token, or key.</p>

<p>Here’s a list of secrets we will need:</p>

<table>
  <thead>
    <tr>
      <th>Secret Key</th>
      <th>説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>SECRET_JWT_PRIVATE_KEY</td>
      <td>A private key used for signing JWT tokens</td>
    </tr>
    <tr>
      <td>SECRET_JWT_PUBLIC_KEY</td>
      <td>A public key used for signing JWT tokens</td>
    </tr>
    <tr>
      <td>DATASTORE_SEQUELIZE_DATABASE</td>
      <td>SQL database name</td>
    </tr>
    <tr>
      <td>DATASTORE_SEQUELIZE_USERNAME</td>
      <td>SQL database username</td>
    </tr>
    <tr>
      <td>DATASTORE_SEQUELIZE_PASSWORD</td>
      <td>SQL database password</td>
    </tr>
    <tr>
      <td>SECRET_OAUTH_CLIENT_ID</td>
      <td>Githubの<a href="https://developer.github.com/v3/oauth">OAuth</a>で使用するClient ID</td>
    </tr>
    <tr>
      <td>SECRET_OAUTH_CLIENT_SECRET</td>
      <td>GithubのOAuthで使用するClient Secret</td>
    </tr>
    <tr>
      <td>WEBHOOK_GITHUB_SECRET</td>
      <td>GitHub webhookに設定して正当性を検証するためのパスワード</td>
    </tr>
    <tr>
      <td>SECRET_PASSWORD</td>
      <td>セッションとOAuthデータを暗号化するためのパスワード。中身は何でもよいですが<strong>32文字以上である必要があります。</strong></td>
    </tr>
    <tr>
      <td>K8S_TOKEN</td>
      <td>用意したKubernetesの<default_token_name></default_token_name></td>
    </tr>
  </tbody>
</table>

<h3 id="generate-jwt-keys">Generate JWT keys</h3>

<p><code class="highlighter-rouge">jwtprivatekey</code>を生成するには次のコマンドを実行します。</p>

<p><code class="highlighter-rouge">$ openssl genrsa -out jwt.pem 2048</code></p>

<p><code class="highlighter-rouge">jwtpublickey</code>を生成するには次のコマンドを実行します。</p>

<p><code class="highlighter-rouge">$ openssl rsa -in jwt.pem -pubout -out jwt.pub</code></p>

<h3 id="oauth-client-idとsecretの取得">OAuth Client IDとSecretの取得</h3>

<ol>
  <li><a href="https://github.com/settings/developers">OAuth applications</a>ページを開きます。</li>
  <li>Register a new applicationをクリックします。</li>
  <li>情報を入力しRegister applicationをクリックします。</li>
</ol>

<p><img src="../../cluster-management/assets/create-oauth-app.png" alt="Create OAuth App" /></p>

<p><code class="highlighter-rouge">Client ID</code>と<code class="highlighter-rouge">Client Secret</code>が表示され、それぞれ<code class="highlighter-rouge">oauthclientid</code>、<code class="highlighter-rouge">oauthclientsecret</code>となります。</p>

<h3 id="create-a-datastore">Create a datastore</h3>

<p>To get your SQL datastore secrets, set up a datastore with <a href="https://us-west-2.console.aws.amazon.com/rds">AWS RDS</a>.</p>

<ol>
  <li>Navigate to <a href="https://us-west-2.console.aws.amazon.com/rds">AWS RDS</a>. Click on Launch a DB Instance.<img src="../../cluster-management/assets/launch-db.png" alt="AWS RDS page" /></li>
  <li>Select the <code class="highlighter-rouge">PostgreSQL</code> tab. Click Select.<img src="../../cluster-management/assets/select-db-engine.png" alt="Select engine" /></li>
  <li>Choose an environment (Production or Dev/Test) and click Next Step.<img src="../../cluster-management/assets/select-db-env.png" alt="Select environment" /></li>
  <li>Fill out the DB Instance Identifier (<code class="highlighter-rouge">DATASTORE_SEQUELIZE_DATABASE</code>), Master Username (<code class="highlighter-rouge">DATASTORE_SEQUELIZE_USERNAME</code>), Master Password (<code class="highlighter-rouge">DATASTORE_SEQUELIZE_PASSWORD</code>), and Confirm Password. Click Next Step.<img src="../../cluster-management/assets/db-details.png" alt="Configure details" /></li>
  <li>Add a Database Name. Make sure the VPC Security Group chosen gives inbound access to all IPs. Click Launch DB Instance.<img src="../../cluster-management/assets/db-settings.png" alt="Configure settings" /></li>
  <li>Click View Your DB Instances. Click on the small triangle next to the Engine column on your DB instance row to open up the details. Your endpoint will be your Database host name.<img src="../../cluster-management/assets/db-hostname.png" alt="Host name" /></li>
</ol>

<h3 id="秘密情報のbase64エンコード">秘密情報のBase64エンコード</h3>

<p>各秘密情報は<a href="http://kubernetes.io/docs/user-guide/secrets/#creating-a-secret-manually">base64エンコード</a>されている必要があるので、それぞれをbase64エンコードします。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span><span class="nb">echo</span> -n <span class="s2">"somejwtprivatekey"</span> | base64
<span class="nv">c29tZWp3dHByaXZhdGVrZXk</span><span class="o">=</span>
<span class="gp">$ </span><span class="nb">echo</span> -n <span class="s2">"anypassword"</span> | base64
<span class="nv">YW55cGFzc3dvcmQ</span><span class="o">=</span>
</code></pre>
</div>

<h3 id="kubernetesにsecretを設定">Kubernetesにsecretを設定</h3>

<p>Kubernetesにsecretを作成するには、秘密情報を入力した<code class="highlighter-rouge">secret.yaml</code>を作成します。入力した情報はKubernetesの<code class="highlighter-rouge">deployment.yaml</code>ファイルで使用されます。</p>

<p>下記のような内容になるはずです。</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="s">kind</span><span class="pi">:</span> <span class="s">Secret</span>
<span class="s">metadata</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">screwdriver-api-secrets</span>
<span class="s">type</span><span class="pi">:</span> <span class="s">Opaque</span>
<span class="s">data</span><span class="pi">:</span>
  <span class="c1"># make sure the values are all base64 encoded</span>
  <span class="s">dbhost</span><span class="pi">:</span> <span class="s">ZGJob3N0bmFtZWhlcmU=</span>
  <span class="s">dbusername</span><span class="pi">:</span> <span class="s">bXlkYXRhYmFzZQ==</span>
  <span class="s">dbpassword</span><span class="pi">:</span> <span class="s">c29tZXBhc3N3b3Jk</span>
  <span class="s">password</span><span class="pi">:</span> <span class="s">YW55cGFzc3dvcmQ=</span>
  <span class="s">oauthclientid</span><span class="pi">:</span> <span class="s">c29tZWNsaWVudGlk</span>
  <span class="s">oauthclientsecret</span><span class="pi">:</span> <span class="s">c29tZWNsaWVudHNlY3JldA==</span>
  <span class="s">jwtprivatekey</span><span class="pi">:</span> <span class="s">c29tZWp3dHByaXZhdGVrZXk=</span>
  <span class="s">jwtpublickey</span><span class="pi">:</span> <span class="s">c29tZWp3dHB1YmxpY2tleQ==</span>
  <span class="s">githubsecret</span><span class="pi">:</span> <span class="s">c29tZWdpdGh1YnNlY3JldA==</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">kubectl create</code>を使用してsecretを作成します。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>kubectl create -f ./secret.yaml
</code></pre>
</div>

<h3 id="追加の環境変数">追加の環境変数</h3>

<p>Screwdriver向けに他の環境変数もカスタマイズできます。全てのリストについては<a href="https://github.com/screwdriver-cd/screwdriver/blob/master/config/custom-environment-variables.yaml">custom-environment-variables.yaml</a>ファイルをご覧ください。</p>

<h2 id="screwdriverのデプロイ">Screwdriverのデプロイ</h2>

<p>You can check out the <code class="highlighter-rouge">api.yaml</code> in the <a href="https://github.com/screwdriver-cd-test/config-examples">Screwdriver config examples repo</a> for example service and deployment definitions to run the Screwdriver API.</p>

<h3 id="serviceの作成">Serviceの作成</h3>

<p>KubernetesのServiceは一連のPodやユニークなIP割り振りなどが定義されたものという概念です。
<a href="http://kubernetes.io/docs/user-guide/connecting-applications/#creating-a-service">Creating a Service</a>ページの手順で<code class="highlighter-rouge">service.yaml</code>を準備します。</p>

<p><a href="https://github.com/screwdriver-cd-test/config-examples/blob/master/kubernetes/api.yaml">api.yaml</a>のような構成になるはずです。</p>

<p>Serviceを作成するには<code class="highlighter-rouge">service.yaml</code>ファイルに対して<code class="highlighter-rouge">kubectl create</code>を実行します。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>kubectl create -f service.yaml
</code></pre>
</div>

<h3 id="kubernetesトークン名の取得">Kubernetesトークン名の取得</h3>

<p>Kubernetes actually sets up your Kubernetes token by default. You will need this for your <code class="highlighter-rouge">deployment.yaml</code>.
You can use <code class="highlighter-rouge">kubectl</code> to see your <a href="http://kubernetes.io/docs/user-guide/secrets/walkthrough/">Kubernetes secrets</a>.</p>

<p>Get the <code class="highlighter-rouge">&lt;DEFAULT_TOKEN_NAME&gt;</code>, by running:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>kubectl get secrets
NAME                      TYPE                                  DATA      AGE
default-token-abc55       kubernetes.io/service-account-token   3         50d
</code></pre>
</div>

<p>The <code class="highlighter-rouge">&lt;DEFAULT_TOKEN_NAME&gt;</code> will be listed under <code class="highlighter-rouge">Name</code> when the <code class="highlighter-rouge">Type</code> is <code class="highlighter-rouge">kubernetes.io/service-account-token</code>.</p>

<h3 id="uriの取得">URIの取得</h3>

<p><code class="highlighter-rouge">deployment.yaml</code>内の<code class="highlighter-rouge">URI</code>を設定するためにLoad Balancer Ingressを取得する必要があります。</p>

<p>次を実行することで<code class="highlighter-rouge">LoadBalancer Ingress</code>が取得できます。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>kubectl describe services sdapi
</code></pre>
</div>

<h3 id="deploymentの作成">Deploymentの作成</h3>

<p>A Deployment makes sure a specified number of pod “replicas” are running at any one time. If there are too many, it will kill some; if there are too few, it will start more. Follow instructions on the <a href="http://kubernetes.io/docs/user-guide/deploying-applications/">Deploying Applications</a> page to create your <code class="highlighter-rouge">deployment.yaml</code>.</p>

<p>It should look like the Deployment in <a href="https://github.com/screwdriver-cd-test/config-examples/blob/master/kubernetes/api.yaml">api.yaml</a>.</p>

<h3 id="デプロイ">デプロイ</h3>

<p>For a fresh deployment, run the <code class="highlighter-rouge">kubectl create</code> command on your <code class="highlighter-rouge">deployment.yaml</code> file:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>kubectl create -f deployment.yaml
</code></pre>
</div>

<h2 id="podsの確認">Podsの確認</h2>

<p>Kubernetesの<a href="http://kubernetes.io/docs/user-guide/pods/">pod</a>はコンテナの集まりで、管理とネットワークの目的でお互いに結びついています。</p>

<p>deploymentによって作成されたpodを確認するには、以下を実行します。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>kubectl get pods
</code></pre>
</div>

<p>Podからの標準出力とエラーを確認するには以下を実行します。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>kubectl logs &lt;POD-NAME&gt;
</code></pre>
</div>

<h2 id="oauth-applicationの更新">OAuth Applicationの更新</h2>

<p>You will need to navigate back to your original OAuth Application that you used for your OAuth Client ID and Secret to update the URLs.</p>

<ol>
  <li><a href="https://github.com/settings/developers">OAuth applications</a>ページを開きます。</li>
  <li>作成したアプリケーションをクリックし、OAuth Client IDとSecretを取得します。</li>
  <li><code class="highlighter-rouge">Homepage URL</code>と<code class="highlighter-rouge">Authorization callback URL</code>をご使用の<code class="highlighter-rouge">LoadBalancer Ingress</code>で埋めてください。</li>
</ol>

</div>
    
</div>

<footer>
    <div class="container">
        <div class="col-xs-6">
            <p>All code on this site is licensed under the <a href="https://github.com/screwdriver-cd/screwdriver/blob/master/LICENSE">Yahoo BSD License</a> unless otherwise stated.</p>
        </div>
        <div class="col-xs-6">
            
            <p>© 2016 Yahoo! Inc. All rights reserved.</p>
            
        </div>
    </div>
</footer>

<script src="/themes/sd/js/jquery-1.10.2.min.js"></script>
<script src="/themes/sd/js/bootstrap-3.0.3.min.js"></script>
<script src="/themes/sd/js/highlight.pack.js"></script>
<script>var base_url = '';</script>
<script>var page_menu = 'menu_ja';</script>
<script src="/themes/sd/js/base.js"></script>


<script src="/js/vendor/jquery-3.1.0.min.js"></script>


<script src="/js/yaml.js"></script>


<script src="/js/lunr.min.js"></script>


<script src="/js/lunr-feed.js"></script>


<div class="modal" id="jekyll_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">x</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <input type="search" class="form-control" id="search" placeholder="Search..." autocomplete="off">
                </form>
                <div id="results" class="all-posts results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

</body>
</html>

